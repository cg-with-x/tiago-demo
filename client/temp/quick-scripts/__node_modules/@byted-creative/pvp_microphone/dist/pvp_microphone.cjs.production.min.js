(function() {"use strict";var __module = CC_EDITOR ? module : {exports:{}};var __filename = 'preview-scripts/__node_modules/@byted-creative/pvp_microphone/dist/pvp_microphone.cjs.production.min.js';var __require = CC_EDITOR ? function (request) {return cc.require(request, require);} : function (request) {return cc.require(request, __filename);};function __define (exports, require, module) {cc._RF.push(module, '', 'pvp_microphone.cjs.production.min', __filename);"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("@byted-creative/stt-promisify")),n=e(require("eventemitter3"));function o(e,t,n,o){return new(n||(n=Promise))((function(r,a){function u(e){try{c(o.next(e))}catch(e){a(e)}}function i(e){try{c(o.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,i)}c((o=o.apply(e,t||[])).next())}))}function r(e,t){var n,o,r,a,u={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return u.label++,{value:a[1],done:!1};case 5:u.label++,o=a[1],a=[0];continue;case 7:a=u.ops.pop(),u.trys.pop();continue;default:if(!((r=(r=u.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){u=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){u.label=a[1];break}if(6===a[0]&&u.label<r[1]){u.label=r[1],r=a;break}if(r&&u.label<r[2]){u.label=r[2],u.ops.push(a);break}r[2]&&u.ops.pop(),u.trys.pop();continue}a=t.call(e,u)}catch(e){a=[6,e],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,i])}}}var a,u=function(){return function(){var e=this;this.promise=new Promise((function(t,n){Object.defineProperties(e,{resolve:{value:function(n){e.value=n,t(n)},writable:!1},reject:{value:n,writable:!1}})}))}}(),i={appID:"",roomNum:"",openID:"",channelID:"",source:"live",audioStatus:{local:!0,remote:!0}},c=null,s=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];c&&c.log(e)};a="undefined"!=typeof tt&&tt.getRtcEngine&&tt.getRtcEngine();var l,d=new n;function f(){return o(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:return e=null,i.audioStatus.local?[4,_().catch((function(e){return e}))]:[3,2];case 1:return e=t.sent(),[3,4];case 2:return[4,A().catch((function(e){return e}))];case 3:e=t.sent(),t.label=4;case 4:return e&&s("设置麦克风状态错误了",e),e=null,i.audioStatus.remote?[4,p().catch((function(e){return e}))]:[3,6];case 5:return e=t.sent(),[3,8];case 6:return[4,L().catch((function(e){return e}))];case 7:e=t.sent(),t.label=8;case 8:return e&&s("设置远端状态错误",e),[2]}}))}))}function _(){var e=new u;return a?(a.enableLocalAudio({success:function(){s("enable local success"),i.audioStatus.local=!0,m(i.openID,i.appID,i.audioStatus.local,i.audioStatus.remote),e.resolve()},fail:function(t){s("enable local fail",t),e.reject({reason:l.ENABLE_LOCAL_AUDIO_FAIL,data:t})}}),e.promise):e.promise}function A(){var e=new u;return a?(a.disableLocalAudio({success:function(){s("disable local success"),i.audioStatus.local=!1,m(i.openID,i.appID,i.audioStatus.local,i.audioStatus.remote),e.resolve()},fail:function(t){s("disable local fail",t),e.reject({reason:l.DISABLE_LOCAL_AUDIO_FAIL,data:t})}}),e.promise):e.promise}function L(){var e=new u;return a?(a.muteAllRemoteAudioStream({success:function(){s("muted success"),i.audioStatus.remote=!1,m(i.openID,i.appID,i.audioStatus.local,i.audioStatus.remote),e.resolve()},fail:function(t){s("muted fail",t),e.reject({reason:l.MUTE_ALL_REMOTE_AUDIO_FAIL,data:t})}}),e.promise):e.promise}function p(){var e=new u;return a?(a.unmuteAllRemoteAudioStream({success:function(){s("unmuted success"),i.audioStatus.remote=!0,m(i.openID,i.appID,i.audioStatus.local,i.audioStatus.remote),e.resolve()},fail:function(t){s("unmuted fail",t),e.reject({reason:l.UNMUTE_ALL_REMOTE_AUDIO_FAIL,data:t})}}),e.promise):e.promise}function m(e,n,a,u){return o(this,void 0,void 0,(function(){return r(this,(function(o){switch(o.label){case 0:return[4,t.request({url:"https://i.snssdk.com/tfe/route/ttg_wonderland/w_proj/update_audio_status",method:"POST",data:{open_id:e,app_id:n,local_audio_status:a,remote_audio_status:u,source:i.source}})];case 1:return o.sent(),[2]}}))}))}!function(e){e[e.GEN_CHANNEL_ERROR=1]="GEN_CHANNEL_ERROR",e[e.GET_AUTH_FAILED=2]="GET_AUTH_FAILED",e[e.JOIN_CHANNEL_FAIL=3]="JOIN_CHANNEL_FAIL",e[e.CONNECTION_LOST=4]="CONNECTION_LOST",e[e.LEAVE_CHANNEL_FAIL=5]="LEAVE_CHANNEL_FAIL",e[e.ENABLE_LOCAL_AUDIO_FAIL=6]="ENABLE_LOCAL_AUDIO_FAIL",e[e.DISABLE_LOCAL_AUDIO_FAIL=7]="DISABLE_LOCAL_AUDIO_FAIL",e[e.MUTE_ALL_REMOTE_AUDIO_FAIL=8]="MUTE_ALL_REMOTE_AUDIO_FAIL",e[e.UNMUTE_ALL_REMOTE_AUDIO_FAIL=9]="UNMUTE_ALL_REMOTE_AUDIO_FAIL"}(l||(l={})),exports.PVPMicrophone={__proto__:null,config:i,setDebugLog:function(e){c=e},log:s,get rtcEngine(){return a},get REASON(){return l},init:function(e){return o(this,void 0,void 0,(function(){var n,o,a,c;return r(this,(function(r){switch(r.label){case 0:Object.assign(i,e),s("init micro params",e),n=new u,r.label=1;case 1:return r.trys.push([1,3,,4]),s("url",a="https://i.snssdk.com/tfe/route/ttg_wonderland/w_proj/generate_room_id?room_number="+i.roomNum+"&open_id="+i.openID+"&app_id="+i.appID+"&source="+i.source),[4,t.request({url:a,method:"GET"})];case 2:return o=r.sent(),s("get channel",o),[3,4];case 3:return c=r.sent(),n.reject({reason:l.GEN_CHANNEL_ERROR,data:c}),[3,4];case 4:return o&&o.data&&o.data.data?(i.channelID=o.data.data.channel_id,i.audioStatus={local:o.data.data.local_audio_status,remote:o.data.data.remote_audio_status},[4,t.authorize({scope:"scope.record"}).catch((function(e){console.log("fail to authorize record"),n.reject({reason:l.GET_AUTH_FAILED,data:e})}))]):[3,6];case 5:return r.sent(),console.log("init success"),n.resolve(i.audioStatus),[3,7];case 6:n.reject({reason:l.GEN_CHANNEL_ERROR,data:o}),r.label=7;case 7:return[2,n.promise]}}))}))},startChat:function(){var e=this,t=new u,n=3;if(!a)return t.promise;var c=function(){return o(e,void 0,void 0,(function(){return r(this,(function(e){return s("joinChannelSuccess"),a&&a.off("joinChannelSuccess",c),s("resolve microphone"),f(),t.resolve(a),[2]}))}))};function _(){n--,a.joinChannel({channelId:i.channelID,uid:i.openID,fail:function(e){s("microphone join channel error"),t.reject({reason:l.JOIN_CHANNEL_FAIL,data:e})}})}return a.on("joinChannelSuccess",c),a.on("userJoined",(function(t){return o(e,void 0,void 0,(function(){return r(this,(function(e){return s("user joined data",t),f(),[2]}))}))})),a.on("connectionLost",(function(e){s("microphone connectionLost"),d.emit("connectionLost",e),t.reject({reason:l.CONNECTION_LOST,data:e})})),a.on("error",(function(e){if(n>=0)return _();s("microphone error"),d.emit("error",e),t.reject({reason:l.JOIN_CHANNEL_FAIL,data:e})})),_(),t.promise},endChat:function(){var e=new u;return a?(a.leaveChannel({success:function(){return e.resolve()},fail:function(t){s("fail to end chat"),e.reject({reason:l.LEAVE_CHANNEL_FAIL,data:t})}}),e.promise):e.promise},enableLocalAudio:_,disableLocalAudio:A,muteAllRemoteAudioStream:L,unmuteAllRemoteAudioStream:p,getDebugInfo:function(){return i},getAudioStatus:function(){return i.audioStatus},on:function(e,t){d.on(e,t)},removeAllListeners:function(){d.removeAllListeners()}};

cc._RF.pop();
        }
        if (CC_EDITOR) {
            __define(__module.exports, __require, __module);
        }
        else {
            cc.registerModuleFunc(__filename, function () {
                __define(__module.exports, __require, __module);
            });
        }
        })();
        
        