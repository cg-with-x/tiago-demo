{"version":3,"sources":["../../../../assets/scripts/assets/scripts/game.js"],"names":["cc","Class","extends","Component","playerAOpenId","playerBOpenId","properties","labelPlayerATip","Label","labelPlayerANickName","spritePlayerAAvatar","Sprite","labelPlayerBTip","labelPlayerBNickName","spritePlayerBAvatar","labelServerTime","start","onClickStopGame","roomManager","room","send","JSON","stringify","event","dataManager","tiago","leaveRTCFromGameRoom","console","warn","isGameEnd","videoTempPath","uploadVideo","then","tt","hideLoading","showToast","title","icon","duration","catch","e","code","gameRecorderManager","stop","leave","director","loadScene","currentTeam","return","onClickTalk","data","parseInt","Math","random","onClickReconnect","reconnect","onRoomMessage","messageStr","message","parse","length","forEach","environment","twoPlayersInfo","renderPlayers","string","renderTalk","playerA","playerB","openId","name","isAI","nickName","utils","renderAvatar","avatarUrl","tip"],"mappings":";;;;;;;;AAAA;;;;AAEA;;;;AACA;;;;;;AAEAA,GAAGC,KAAH,CAAS;AACPC,WAASF,GAAGG,SADL;;AAGPC,iBAAe,EAHR;AAIPC,iBAAe,EAJR;;AAMPC,cAAY;AACVC,qBAAiBP,GAAGQ,KADV;AAEVC,0BAAsBT,GAAGQ,KAFf;AAGVE,yBAAqBV,GAAGW,MAHd;;AAKVC,qBAAiBZ,GAAGQ,KALV;AAMVK,0BAAsBb,GAAGQ,KANf;AAOVM,yBAAqBd,GAAGW,MAPd;;AASVI,qBAAiBf,GAAGQ;AATV,GANL;;AAkBPQ,OAlBO,mBAkBC,CAAE,CAlBH;AAoBPC,iBApBO,6BAoBW;AAChBC,2BAAYC,IAAZ,CAAiBC,IAAjB,CACEC,KAAKC,SAAL,CAAe;AACbC,aAAO;AADM,KAAf,CADF;AAKA;AACA,QAAIC,uBAAYC,KAAhB,EACED,uBAAYC,KAAZ,CAAkBC,oBAAlB,CAAuCR,uBAAYC,IAAnD;AACFQ,YAAQC,IAAR,CAAa,MAAb;AACAJ,2BAAYK,SAAZ,GAAwB,IAAxB;;AAEA,QACEL,uBAAYC,KAAZ,IACAD,uBAAYM,aADZ,IAEAN,uBAAYK,SAHd,EAIE;AACAL,6BAAYC,KAAZ,CACGM,WADH,CACeP,uBAAYM,aAD3B,EAC0C,kBAD1C,EAEGE,IAFH,CAEQ,YAAM;AACVC,WAAGC,WAAH;AACAD,WAAGE,SAAH,CAAa;AACXC,uDADW;AAEXC,gBAAM,MAFK;AAGXC,oBAAU;AAHC,SAAb;AAKD,OATH,EAUGC,KAVH,CAUS,UAACC,CAAD,EAAO;AACZP,WAAGC,WAAH;AACA,YAAIM,EAAEC,IAAF,KAAW,GAAf,EAAoB;AAClBR,aAAGC,WAAH;AACAD,aAAGE,SAAH,CAAa;AACXC,yDADW;AAEXC,kBAAM,MAFK;AAGXC,sBAAU;AAHC,WAAb;AAKD;AACF,OApBH;AAqBD;AACD,QAAId,uBAAYkB,mBAAhB,EAAqC;AACnClB,6BAAYkB,mBAAZ,CAAgCC,IAAhC;AACD;AACDzB,2BAAY0B,KAAZ;AACA5C,OAAG6C,QAAH,CAAYC,SAAZ,CAAsB,OAAtB;;AAEA;AACA,QAAItB,uBAAYuB,WAAhB,EAA6BvB,uBAAYuB,WAAZ,CAAwBC,MAAxB;AAC9B,GAnEM;AAqEPC,aArEO,yBAqEO;AACZ,QAAI/B,uBAAYC,IAAhB,EAAsB;AACpBD,6BAAYC,IAAZ,CAAiBC,IAAjB,CACEC,KAAKC,SAAL,CAAe;AACbC,eAAO,MADM;AAEb2B,cAAMC,SAASC,KAAKC,MAAL,KAAgB,GAAzB;AAFO,OAAf,CADF;AAMD;AACF,GA9EM;AAgFPC,kBAhFO,8BAgFY;AACjB,QAAIpC,uBAAYC,IAAhB,EAAsB;AACpBD,6BAAYC,IAAZ,CAAiBoC,SAAjB;AACD;AACF,GApFM;AAsFPC,eAtFO,yBAsFOC,UAtFP,EAsFmB;AAAA;;AACxB;AACA;AACA,QAAMC,UAAUrC,KAAKsC,KAAL,CAAWF,UAAX,CAAhB;;AAEA,QAAIC,QAAQE,MAAZ,EAAoB;AAClBF,cAAQG,OAAR,CAAgB,gBAAqB;AAAA,YAAlBtC,KAAkB,QAAlBA,KAAkB;AAAA,YAAX2B,IAAW,QAAXA,IAAW;;AACnC,gBAAQ3B,KAAR;AACE,eAAK,YAAL;AACE;AACF,eAAK,aAAL;AACEC,mCAAYsC,WAAZ,GAA0BZ,IAA1B;AACA;AACF,eAAK,MAAL;AACE1B,mCAAYuC,cAAZ,GAA6Bb,IAA7B;AACA,kBAAKc,aAAL;AACA;AACF,eAAK,aAAL;AACE,kBAAKjD,eAAL,CAAqBkD,MAArB,GAAiCzC,uBAAYsC,WAA7C,UAA6DZ,IAA7D;AACA;AACF,eAAK,MAAL;AACE,kBAAKgB,UAAL,CAAgBhB,IAAhB;AACA;AACF,eAAK,WAAL;AACE;AACA,gBAAI1B,uBAAYC,KAAhB,EACED,uBAAYC,KAAZ,CAAkBC,oBAAlB,CAAuCR,uBAAYC,IAAnD;AACFD,mCAAY0B,KAAZ;AACA5C,eAAG6C,QAAH,CAAYC,SAAZ,CAAsB,OAAtB;AACA;AACA,gBAAItB,uBAAYuB,WAAhB,EAA6BvB,uBAAYuB,WAAZ,CAAwBC,MAAxB;AAC7BrB,oBAAQC,IAAR,CAAa,MAAb;AACAJ,mCAAYK,SAAZ,GAAwB,IAAxB;;AAEA,gBACEL,uBAAYC,KAAZ,IACAD,uBAAYM,aADZ,IAEAN,uBAAYK,SAHd,EAIE;AACAL,qCAAYC,KAAZ,CACGM,WADH,CACeP,uBAAYM,aAD3B,EAC0C,kBAD1C,EAEGE,IAFH,CAEQ,YAAM;AACVC,mBAAGC,WAAH;AACAD,mBAAGE,SAAH,CAAa;AACXC,+DADW;AAEXC,wBAAM,MAFK;AAGXC,4BAAU;AAHC,iBAAb;AAKD,eATH,EAUGC,KAVH,CAUS,UAACC,CAAD,EAAO;AACZ,oBAAIA,EAAEC,IAAF,KAAW,GAAf,EAAoB;AAClBR,qBAAGC,WAAH;AACAD,qBAAGE,SAAH,CAAa;AACXC,iEADW;AAEXC,0BAAM,MAFK;AAGXC,8BAAU;AAHC,mBAAb;AAKD;AACF,eAnBH;AAoBD;AACD,gBAAId,uBAAYkB,mBAAhB,EAAqC;AACnClB,qCAAYkB,mBAAZ,CAAgCC,IAAhC;AACD;;AAED;AACF;AACE;AA3DJ;AA6DD,OA9DD;AA+DD;AACF,GA5JM;AA8JPqB,eA9JO,2BA8JS;AACd,QAAIxC,uBAAYuC,cAAhB,EAAgC;AAAA,iDACHvC,uBAAYuC,cADT;AAAA,UACvBI,OADuB;AAAA,UACdC,OADc;;AAG9B,UAAID,OAAJ,EAAa;AACX,aAAK/D,aAAL,GAAqB+D,QAAQE,MAA7B;AACA,YAAMC,OAAOH,QAAQI,IAAR,YACFJ,QAAQK,QADN,GAETL,QAAQK,QAFZ;AAGA,aAAK/D,oBAAL,CAA0BwD,MAA1B,GAAmCK,IAAnC;AACAG,wBAAMC,YAAN,CAAmB,KAAKhE,mBAAxB,EAA6CyD,QAAQQ,SAArD;AACD;;AAED,UAAIP,OAAJ,EAAa;AACX,aAAK/D,aAAL,GAAqB+D,QAAQC,MAA7B;AACA,YAAMC,QAAOF,QAAQG,IAAR,YACFH,QAAQI,QADN,GAETJ,QAAQI,QAFZ;AAGA,aAAK3D,oBAAL,CAA0BoD,MAA1B,GAAmCK,KAAnC;AACAG,wBAAMC,YAAN,CAAmB,KAAK5D,mBAAxB,EAA6CsD,QAAQO,SAArD;AACD;AACF;AACF,GApLM;AAsLPT,YAtLO,6BAsLsB;AAAA,QAAhBG,MAAgB,SAAhBA,MAAgB;AAAA,QAARnB,IAAQ,SAARA,IAAQ;;AAC3B,QAAM0B,+BAAc1B,IAApB;AACA,QAAImB,WAAW,KAAKjE,aAApB,EAAmC;AACjC,WAAKG,eAAL,CAAqB0D,MAArB,GAA8BW,GAA9B;AACD,KAFD,MAEO,IAAIP,WAAW,KAAKhE,aAApB,EAAmC;AACxC,WAAKO,eAAL,CAAqBqD,MAArB,GAA8BW,GAA9B;AACD;AACF;AA7LM;;AA+LP;AA/LF","file":"game.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["import roomManager from \"./room_manager\";\n\nimport utils from \"./utils\";\nimport dataManager from \"./data_manager\";\n\ncc.Class({\n  extends: cc.Component,\n\n  playerAOpenId: \"\",\n  playerBOpenId: \"\",\n\n  properties: {\n    labelPlayerATip: cc.Label,\n    labelPlayerANickName: cc.Label,\n    spritePlayerAAvatar: cc.Sprite,\n\n    labelPlayerBTip: cc.Label,\n    labelPlayerBNickName: cc.Label,\n    spritePlayerBAvatar: cc.Sprite,\n\n    labelServerTime: cc.Label,\n  },\n\n  start() {},\n\n  onClickStopGame() {\n    roomManager.room.send(\n      JSON.stringify({\n        event: \"bye\",\n      })\n    );\n    // NOTE: 推出连麦\n    if (dataManager.tiago)\n      dataManager.tiago.leaveRTCFromGameRoom(roomManager.room);\n    console.warn(\"游戏结束\");\n    dataManager.isGameEnd = true;\n\n    if (\n      dataManager.tiago &&\n      dataManager.videoTempPath &&\n      dataManager.isGameEnd\n    ) {\n      dataManager.tiago\n        .uploadVideo(dataManager.videoTempPath, \"Hello Wonderland\")\n        .then(() => {\n          tt.hideLoading();\n          tt.showToast({\n            title: `录屏上传成功`,\n            icon: \"none\",\n            duration: 3000,\n          });\n        })\n        .catch((e) => {\n          tt.hideLoading();\n          if (e.code !== 401) {\n            tt.hideLoading();\n            tt.showToast({\n              title: `录屏上传失败`,\n              icon: \"none\",\n              duration: 3000,\n            });\n          }\n        });\n    }\n    if (dataManager.gameRecorderManager) {\n      dataManager.gameRecorderManager.stop();\n    }\n    roomManager.leave();\n    cc.director.loadScene(\"start\");\n\n    // NOTE: 如果之前在一个组队中，则回到队伍\n    if (dataManager.currentTeam) dataManager.currentTeam.return();\n  },\n\n  onClickTalk() {\n    if (roomManager.room) {\n      roomManager.room.send(\n        JSON.stringify({\n          event: \"talk\",\n          data: parseInt(Math.random() * 100),\n        })\n      );\n    }\n  },\n\n  onClickReconnect() {\n    if (roomManager.room) {\n      roomManager.room.reconnect();\n    }\n  },\n\n  onRoomMessage(messageStr) {\n    // NOTE: 消息体的内容是开发者自己定义的，这里的代码只是一种示例\n    // NOTE: 开发者可以根据自己的房间脚本和协议，实现自身游戏的逻辑\n    const message = JSON.parse(messageStr);\n\n    if (message.length) {\n      message.forEach(({ event, data }) => {\n        switch (event) {\n          case \"game-start\":\n            break;\n          case \"environment\":\n            dataManager.environment = data;\n            break;\n          case \"info\":\n            dataManager.twoPlayersInfo = data;\n            this.renderPlayers();\n            break;\n          case \"server-time\":\n            this.labelServerTime.string = `${dataManager.environment}: ${data}`;\n            break;\n          case \"talk\":\n            this.renderTalk(data);\n            break;\n          case \"game-over\":\n            // NOTE: 推出连麦\n            if (dataManager.tiago)\n              dataManager.tiago.leaveRTCFromGameRoom(roomManager.room);\n            roomManager.leave();\n            cc.director.loadScene(\"start\");\n            // NOTE: 如果之前在一个组队中，则回到队伍\n            if (dataManager.currentTeam) dataManager.currentTeam.return();\n            console.warn(\"游戏结束\");\n            dataManager.isGameEnd = true;\n\n            if (\n              dataManager.tiago &&\n              dataManager.videoTempPath &&\n              dataManager.isGameEnd\n            ) {\n              dataManager.tiago\n                .uploadVideo(dataManager.videoTempPath, \"Hello Wonderland\")\n                .then(() => {\n                  tt.hideLoading();\n                  tt.showToast({\n                    title: `录屏上传成功`,\n                    icon: \"none\",\n                    duration: 3000,\n                  });\n                })\n                .catch((e) => {\n                  if (e.code !== 401) {\n                    tt.hideLoading();\n                    tt.showToast({\n                      title: `录屏上传失败`,\n                      icon: \"none\",\n                      duration: 3000,\n                    });\n                  }\n                });\n            }\n            if (dataManager.gameRecorderManager) {\n              dataManager.gameRecorderManager.stop();\n            }\n\n            break;\n          default:\n            break;\n        }\n      });\n    }\n  },\n\n  renderPlayers() {\n    if (dataManager.twoPlayersInfo) {\n      const [playerA, playerB] = dataManager.twoPlayersInfo;\n\n      if (playerA) {\n        this.playerAOpenId = playerA.openId;\n        const name = playerA.isAI\n          ? `AI: ${playerA.nickName}`\n          : playerA.nickName;\n        this.labelPlayerANickName.string = name;\n        utils.renderAvatar(this.spritePlayerAAvatar, playerA.avatarUrl);\n      }\n\n      if (playerB) {\n        this.playerBOpenId = playerB.openId;\n        const name = playerB.isAI\n          ? `AI: ${playerB.nickName}`\n          : playerB.nickName;\n        this.labelPlayerBNickName.string = name;\n        utils.renderAvatar(this.spritePlayerBAvatar, playerB.avatarUrl);\n      }\n    }\n  },\n\n  renderTalk({ openId, data }) {\n    const tip = `战斗力 +${data}`;\n    if (openId === this.playerAOpenId) {\n      this.labelPlayerATip.string = tip;\n    } else if (openId === this.playerBOpenId) {\n      this.labelPlayerBTip.string = tip;\n    }\n  },\n\n  // update (dt) {},\n});\n"]}