{"version":3,"sources":["../../../../assets/scripts/assets/scripts/multi_game.js"],"names":["cc","Class","extends","Component","properties","chatRoot","Node","labelServerTime","Label","settlementRoot","labelResult","players","default","bestScorePlayer","bestScore","start","active","onClickStopGame","roomManager","room","send","JSON","stringify","event","showSettlement","onClickTalk","data","parseInt","Math","random","onClickReconnect","reconnect","onClickBack","director","loadScene","dataManager","tiago","leaveRTCFromGameRoom","leave","console","warn","isGameEnd","currentTeam","return","videoTempPath","uploadVideo","then","tt","hideLoading","showToast","title","icon","duration","catch","e","code","gameRecorderManager","stop","onRoomMessage","messageStr","log","message","parse","length","forEach","environment","multiPlayersInfo","renderPlayers","string","renderTalk","recordBestScore","removeAllChildren","i","player","openId","label","addComponent","addChild","node","y","info","tip","self","getUserInfo","isMe","name","isAI","nickName","Number"],"mappings":"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","file":"multi_game.js","sourceRoot":"../../../../assets/scripts","sourcesContent":["import roomManager from \"./room_manager\";\n\nimport utils from \"./utils\";\nimport dataManager from \"./data_manager\";\n\ncc.Class({\n  extends: cc.Component,\n\n  properties: {\n    chatRoot: cc.Node,\n    labelServerTime: cc.Label,\n    settlementRoot: cc.Node,\n    labelResult: cc.Label,\n    players: {\n      default: {},\n    },\n    bestScorePlayer: {\n      default: \"\",\n    },\n    bestScore: {\n      default: 0,\n    },\n  },\n\n  start() {\n    this.settlementRoot.active = false;\n  },\n\n  onClickStopGame() {\n    roomManager.room.send(\n      JSON.stringify({\n        event: \"bye\",\n      })\n    );\n    this.showSettlement();\n  },\n\n  onClickTalk() {\n    if (roomManager.room) {\n      roomManager.room.send(\n        JSON.stringify({\n          event: \"talk\",\n          data: parseInt(Math.random() * 100),\n        })\n      );\n    }\n  },\n\n  onClickReconnect() {\n    if (roomManager.room) {\n      roomManager.room.reconnect();\n    }\n  },\n\n  onClickBack() {\n    cc.director.loadScene(\"start\");\n\n    // NOTE: 退出连麦\n    if (dataManager.tiago)\n      dataManager.tiago.leaveRTCFromGameRoom(roomManager.room);\n    roomManager.leave();\n    console.warn(\"游戏结束\");\n    dataManager.isGameEnd = true;\n\n    // NOTE: 如果之前在一个组队中，则回到队伍\n    if (dataManager.currentTeam) dataManager.currentTeam.return();\n    if (dataManager.tiago && dataManager.videoTempPath && dataManager.isGameEnd) {\n      dataManager.tiago\n        .uploadVideo(dataManager.videoTempPath, \"Hello Wonderland\")\n        .then(() => {\n          tt.hideLoading();\n          tt.showToast({\n            title: `录屏上传成功`,\n            icon: \"none\",\n            duration: 3000,\n          });\n        })\n        .catch((e) => {\n          tt.hideLoading();\n          if (e.code !== 401) {\n            tt.hideLoading();\n            tt.showToast({\n              title: `录屏上传失败`,\n              icon: \"none\",\n              duration: 3000,\n            });\n          }\n        });\n    }\n    if (dataManager.gameRecorderManager) {\n      dataManager.gameRecorderManager.stop();\n    }\n  },\n\n  onRoomMessage(messageStr) {\n    // NOTE: 消息体的内容是开发者自己定义的，这里的代码只是一种示例\n    // NOTE: 开发者可以根据自己的房间脚本和协议，实现自身游戏的逻辑\n    console.log(\"message received\", messageStr);\n    const message = JSON.parse(messageStr);\n\n    if (message.length) {\n      message.forEach(({ event, data }) => {\n        switch (event) {\n          case \"game-start\":\n            break;\n          case \"environment\":\n            dataManager.environment = data;\n            break;\n          case \"info\":\n            dataManager.multiPlayersInfo = data;\n            this.renderPlayers();\n            break;\n          case \"server-time\":\n            this.labelServerTime.string = `${dataManager.environment}: ${data}`;\n            break;\n          case \"talk\":\n            this.renderTalk(data);\n            this.recordBestScore(data);\n            break;\n          case \"game-over\":\n            this.showSettlement();\n            break;\n          default:\n            break;\n        }\n      });\n    }\n  },\n\n  renderPlayers() {\n    if (dataManager.multiPlayersInfo) {\n      const players = dataManager.multiPlayersInfo;\n\n      this.chatRoot.removeAllChildren();\n      this.players = [];\n\n      for (let i = 0; i < players.length; i++) {\n        const player = players[i];\n        const openId = player.openId;\n        const label = new cc.Node().addComponent(cc.Label);\n        this.chatRoot.addChild(label.node);\n        label.node.y = -i * 70;\n\n        this.players[openId] = {\n          openId,\n          info: player,\n          label,\n        };\n\n        this.renderTalk({ openId, data: \"\" });\n      }\n    }\n  },\n\n  renderTalk({ openId, data }) {\n    const tip = `战斗力 +${data}`;\n    const player = this.players[openId];\n    const self = dataManager.tiago.getUserInfo();\n\n    if (player && self) {\n      const isMe = player.openId === self.openId;\n      let name = player.info.isAI\n        ? `AI: ${player.info.nickName}`\n        : player.info.nickName;\n      if (isMe) name = `${name}(我)`;\n      player.label.string = `${name}: ${tip}`;\n    }\n  },\n\n  recordBestScore({ openId, data }) {\n    if (this.bestScore < Number(data)) {\n      this.bestScore = Number(data);\n      const player = this.players[openId];\n      if (player) {\n        this.bestScorePlayer = player.info.nickName;\n      }\n    }\n  },\n\n  showSettlement() {\n    this.settlementRoot.active = true;\n    if (this.bestScorePlayer) {\n      this.labelResult.string = `${this.bestScorePlayer}最高打出最高伤害: +${this.bestScore}`;\n    }\n  },\n\n  // update (dt) {},\n});\n"]}